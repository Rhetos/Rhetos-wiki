# Migrating from DeployPackages to Rhetos.MSBuild with Rhetos CLI

This article describes how to migrate and existing **Rhetos application or Rhetos plugin package**
from old build and deployment process (with DeployPackages) to new one (Rhetos.MSBuild with Rhetos CLI).

Before migrating an existing application to Rhetos CLI, first
**upgrade your application to Rhetos v4.0 while still using DeployPackages**.
The upgrade instructions are in "Breaking changes" section
in [Rhetos release notes](https://github.com/Rhetos/Rhetos/blob/master/ChangeLog.md).

After the update, migrate from DeployPackages to Rhetos.MSBuild with Rhetos CLI,
by following the instruction in this article.

Content:

1. [New application in Visual Studio](#new-application-in-visual-studio)
2. [NuGet packages must contain DLLs in "lib" instead of "Plugins"](#nuget-packages-must-contain-dlls-in-lib-instead-of-plugins)
3. [Generated application folder structure is different](#generated-application-folder-structure-is-different)
4. [Build options are not read from Web.config file](#build-options-are-not-read-from-webconfig-file)
5. [The "Resources" folder is not generated by default](#the-resources-folder-is-not-generated-by-default)
6. [Custom usage of AssemblyGenerator](#custom-usage-of-assemblygenerator)

## New application in Visual Studio

Rhetos applications with DeployPackages were created by unpacking RhetosServer.zip installation
file, that contained the web application.

Backup the old Rhetos application and create the new Rhetos web application from scratch
in Visual Studio, following the instructions from [Creating new WCF Rhetos application](Creating-new-WCF-Rhetos-application).
After creating the web application:

1. Move your DSL scripts into DslScripts subfolder in that application, and add them to the project
   in Visual Studio (Solution Explorer).
2. Add required NuGet packages (from the list in old RhetosPackages.config).
3. If you were using any custom NuGet source in RhetosPackageSources.config (e.g. network folders
   or private NuGet galleries), make sure to add the custom package source in
   [Visual Studio settings](https://docs.microsoft.com/en-us/nuget/consume-packages/install-use-packages-visual-studio#package-sources).

## NuGet packages must contain DLLs in "lib" instead of "Plugins"

Rhetos NuGet packages with DLLs in "Plugins" folder are not supported by Rhetos CLI.
The warning will be reported on build if any package contains DLLs in Plugins folder,
but the build might also fail with `Unknown DSL keyword` error because of the missing libraries
from Plugins folder.

1. To update your Rhetos plugin, in .nuspec files **replace** `target="Plugins"` with `target="lib"`,
   to match the standard NuGet convention.

## Generated application folder structure is different

Code that used legacy Paths class will still work (it will point to new folders),
but we recommend to use new classes instead (RhetosAppEnvironment, RhetosBuildEnvironment or IAssetsOptions).

* bin => bin
* bin\Plugins => bin
* bin\Generated:
  * assets files => bin\RhetosAssets
  * generated source => bin\DebugSource (different file names, separated by modules)
  * generated binaries are now part of generated application => bin
  * Note that at build-time, the generated source is compiled from obj\Rhetos\RhetosSource,
    and assets are generated in obj\Rhetos\RhetosAssets.
* Resources => Resources (unless _buildOptions.UseLegacyResourcesFolder is false)

Most notable difference is that some plugin packages that generated custom assets
files in `bin\Generated` folder (such as **MvcModelGenerator**) will now generate
the files in `bin\RhetosAssets`.

1. **Modify** your build scripts and project files to look for generated assets
   in `bin\RhetosAssets` instead of `bin\Generated`.

## Build options are not read from Web.config file

For applications built with Rhetos CLI, *Web.config* file (`appSettings` element) can contain
only configuration settings for run-time environment and database update.
Build configuration must be moved from *Web.config* to *rhetos-build.settings.json* file.

1. **Remove** the following 3 build settings from *Web.config*.

    ```xml
    <appSettings file="ExternalAppSettings.config">
      <add key="CommonConcepts.Legacy.AutoGeneratePolymorphicProperty" value="False" />
      <add key="CommonConcepts.Legacy.CascadeDeleteInDatabase" value="False" />
      <add key="Dsl.InitialConceptsSort" value="Key" />
    </appSettings>
    ```

2. Place them in *rhetos-build.settings.json* file, located in the project root folder
   (with the .csproj file). Make sure to **replace these values** with your old ones,
   or **remove** the settings if they were not configured in *Web.config*.

    ```json
    {
      "CommonConcepts": {
        "Legacy": {
          "AutoGeneratePolymorphicProperty": false,
          "CascadeDeleteInDatabase": false
        }
      },
      "Dsl": {
        "InitialConceptsSort": "Key"
      }
    }
    ```

3. You can **leave the other** `appSettings` values in *Web.config*, or move them to the run-time
   configuration file *rhetos-app.settings.json* (not *rhetos-build.settings.json*!).

See [Build configuration](Configuration-management#build-configuration) chapter for more details.

## The "Resources" folder is not generated by default

1. For existing applications and plugins to work, **enable** "Resources" folder
   in `rhetos-build.settings.json` file with `"Legacy": { "BuildResourcesFolder": true }`.

## Custom usage of AssemblyGenerator

1. If your application or plugin package directly uses `IAssemblyGenerator`
   to generate files for other applications (client helpers, for example), not for the main
   application, then **add** an empty `manifestResources` parameter to make sure that
   these files are generated as custom assets, and not as part of the new application runtime.
   * If the embedded resources parameter is provided (even if empty), it will generated source files and
     compiled library (DLL) in `bin\RhetosAssets` folders instead of `bin\Generated`.
     These files are consider as custom assets, not as an executable part of the main application runtime.
   * If the embedded resources are not provided, it will generate source files only (C#) as part of
     the main application. These files will be compiled into the main Rhetos application
     and used at runtime.
