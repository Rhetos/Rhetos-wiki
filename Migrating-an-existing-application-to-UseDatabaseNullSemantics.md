# Migrating an existing application to UseDatabaseNullSemantics

Contents:

1. [What is UseDatabaseNullSemantics](#what-is-usedatabasenullsemantics)
2. [Recommendations for Rhetos applications](#recommendations-for-rhetos-applications)
3. [How to change UseDatabaseNullSemantics in Rhetos application](#how-to-change-usedatabasenullsemantics-in-rhetos-application)
4. [Testing and migrating the existing features in your application](#testing-and-migrating-the-existing-features-in-your-application)

## What is UseDatabaseNullSemantics

UseDatabaseNullSemantics in an Entity Framework configuration setting that modifies how EF
generates SQL queries.
The change is briefly described in MSDN article
[DbContextConfiguration.UseDatabaseNullSemantics Property](https://docs.microsoft.com/en-us/dotnet/api/system.data.entity.infrastructure.dbcontextconfiguration.usedatabasenullsemantics?view=entity-framework-6.2.0).

If UseDatabaseNullSemantics is set to false,
EF will generate SQL queries with NULL value handling more similar to C#,
but may result with slower execution time in some complex cases. For example:

| LINQ query | SQL generated by EF with UseDatabaseNullSemantics=True | SQL generated by EF with UseDatabaseNullSemantics=False |
| --- | --- | --- |
| `query.Where(a => a.X == b)` | `SELECT .. FROM ... WHERE a.X = b` | `SELECT .. FROM ... WHERE (((a.X = b) AND (NOT (a.X IS NULL OR b IS NULL))) OR ((a.X IS NULL) AND (b IS NULL)))`
| `query.Select(person => person.FirstName + " " + person.LastName)` | `SELECT person.FirstName + N' ' + person.LastName` | `SELECT CASE WHEN (person.FirstName IS NULL) THEN N'' ELSE person.FirstName END + N' ' + CASE WHEN (person.LastName IS NULL) THEN N'' ELSE person.LastName END`

## Recommendations for Rhetos applications

For **new Rhetos applications** it is recommended to set UseDatabaseNullSemantics to **True**,
because of the performance impact. This means that when writing LINQ queries, the developer
should apply the similar logic as in SQL queries:
comparison operator with null values will always return false,
for example `Where(x => x.a==x.b)` will not return records when `a` is null and `b` is null.

For **existing applications** that are already in production, it is usually not worth the effort
to modify this setting, because it would require testing of all the existing features
and adjusting the implementation where needed. More on this is described in the following sections.

## How to change UseDatabaseNullSemantics in Rhetos application

In *Web.config* file, add or modify the following `appSettings` element:

```xml
<add key="EntityFramework.UseDatabaseNullSemantics" value="True" />
```

## Testing and migrating the existing features in your application

Changing the UseDatabaseNullSemantics setting will affect all SQL queries generated by Entity Framework,
which includes all filters (ItemFilter, ComposableFilterBy), row permission,
and any other applications feature that uses LINQ queries.

* All those features in your application should be tested for null value handling, and corrected if needed.

Examples of LINQ queries that **need** to be changed:

| LINQ | Explanation |
| --- | --- |
| `Where(a => a.X == searchvalue)` | If `searchvalue` can be set to null, setting UseDatabaseNullSemantics=true will not longer return the records with a=null. Modify to `Where(a => a.X == searchvalue || a.X == null && searchvalue == null)` if you need to read the null values.
| Validations that search for forbidden values e.g. `item.IsAllowed != true` or `item.StatusID != Const.StatusOk` | With UseDatabaseNullSemantics disable, those queries will correctly return null values as invalid. With UseDatabaseNullSemantics enabled, modify the expressions to "`item.IsAllowed != true || item.IsAllowed == null`", or "`item.StatusID != Const.StatusOk || item.StatusID == null`".
| `query.Select(person => person.FirstName + " " + person.LastName)` | String concatenation with UseDatabaseNullSemantics will result with NULL if any of the elements are null, because the generated SQL query is simply "`SELECT person.FirstName + N' ' + person.LastName`". With UseDatabaseNullSemantics disabled, the generated SQL query contains check for null value and concatenates empty string instead.

Examples of LINQ queries that **do not need** to be changed:

| LINQ | Explanation |
| --- | --- |
| `Where(a => a.X != null)` | Null literals (constants) will result with correct SQL, e.g. `a.X IS NOT NULL`.
| `.ToList().Where(a => a.X == null)` | Any LINQ query that is executed **on objects in memory**, not on database, is not affected by UseDatabaseNullSemantics.
