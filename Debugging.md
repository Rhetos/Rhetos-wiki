# Debugging

Applications build with Rhetos are basically standard C# applications, and can bi debugged
directly in Visual Studio.
See the instruction in a corresponding section below, depending on which Rhetos build process
is used in your application.

Contents:

1. [Debugging applications built with Rhetos CLI and Rhetos MSBuild integration](#debugging-applications-built-with-rhetos-cli-and-rhetos-msbuild-integration)
2. [Debugging applications built with DeployPackages](#debugging-applications-built-with-deploypackages)
3. [Tips and Tricks](#tips-and-tricks)

## Debugging applications built with Rhetos CLI and Rhetos MSBuild integration

Applications that are built with Rhetos CLI are standard WCF applications;
they can be debugged directly in Visual Studio.

Alternatively, if you are using IIS, instead of running the application from Visual Studio,
you can also *attach* Visual Studio to the existing IIS web application process.

Example scenario:

> For example, let's debug the code in filter "`ComposableFilterBy LongBooks3`",
from the [ExampleFilters.rhe](https://github.com/Rhetos/Bookstore/blob/master/src/Bookstore.Service/DslScripts/AdditionalExamples/ExampleFilters.rhe) script,
in the [Bookstore](https://github.com/Rhetos/Bookstore) demo application.

Steps:

1. Open Bookstore.sln in Visual Studio and build the solution.
2. In Solution Explorer select project "Bookstore.Service" and click "Show All Files" button.
   This will make visible the generated source files in obj folder.
3. Open generated source file `obj\Rhetos\RhetosSource\Repositories\BookstoreRepositories.cs`,
   it contains the feature implementation that we need to debug.
4. In the source file search for the line that contains code from the LongBooks3 filter:
   `filtered = filtered.Where(item => item.Extension_ForeignBook.ID != null);`
    * This is the Filter method that implements the LongBooks3 filter.
5. Put the breakpoint (F9) at the line "return filtered;".
6. Right-click on "Bookstore.Service" project, click "Set as Startup Project",
   and Run the application (F5).
7. Browser will open automatically. In the address bar, add to following to the existing base URL,
   to execute web request that will start up the application process and call the filter:
   * `/rest/Bookstore/Book/?filters=[{"Filter":"Bookstore.LongBooks3","Value":{"MinimumPages":300}}]`
8. Visual Studio should automatically pause the process on the breakpoint.
    * Move the mouse pointer over the `parameter` variable. You should see the command parameters:
      ForeignBooksOnly=null, MinimumPages=300.
    * Add a Watch entry: `filtered.ToString()`. It should display the SQL query generated by Entity Framework.
      * If you get a warning "The function evaluation requires all threads to run.",
        click the thread icon next to the warning.

See [Tips and Tricks](#tips-and-tricks) section below for more information on how to simplify debugging.

## Debugging applications built with DeployPackages

Rhetos DSL brings a new level of abstraction in the work of developers,
which can result with additional complexity to debugging.
Fortunately, Rhetos generates a common C# web service (source, DLL and PDB),
based on the DSL scripts. When we need to debug the generated application,
we can simply start Visual Studio and debug the Rhetos application like
any other application that has been written in C#.

To be able to use breakpoints and step through the code of the generated application
in Visual Studio, you will need to make sure that the Visual Studio has loaded
the debugging symbols.
Use one of the two options:

* A) Build the ServerDom DLLs in *Debug* mode, with `DeployPackages.exe /Debug` switch.
  Visual Studio loads the debug symbols automatically for debug-mode DLLs.
* B) Alternatively, to debug the application in *Release* mode,
  in Visual Studio => Tools => Options turn off the option "Just My Code".
  That option disables debugging of optimized DLL's from the external processes.
  This is not a preferred solution because when debugging a release-mode DLL you will have
  less information available in the Visual Studio (less variables, some breakpoint not working, etc.)

Example scenario:

> For example, let's debug the code in filter "`ComposableFilterBy LongBooks3`",
from the [ExampleFilters.rhe](https://github.com/Rhetos/Bookstore/blob/rhetos-2/src/DslScripts/AdditionalExamples/ExampleFilters.rhe) script,
in the [Bookstore](https://github.com/Rhetos/Bookstore) demo application.

If you are using the Bookstore demo application for debugging,
make sure to checkout the git branch **rhetos-2**,
that contains the older version of the application with DeployPackages.

Steps:

1. Build the Rhetos application with the `/Debug` switch,
   or configure Visual Studio to debug the DLLs that built in the release mode (see above).
   * You can see in Bookstore's [build script](https://github.com/Rhetos/Bookstore/blob/rhetos-2/Build.ps1)
     that the `/Debug` switch is already set.
2. Open Visual Studio with *Run as Administrator* (don't open a project or a solution).
   * Running VS as administrator is required when debugging IIS web applications.
3. In Visual Studio, open file `dist\BookstoreRhetosServer\bin\Generated\ServerDom.Repositories.cs`,
   it contains the feature implementation that we need to debug.
   * You can debug any other generated source file, but most of the business features usually
     end up in the repository classes.
4. In the source file search for the line that contains code from the LongBooks3 filter:
   `filtered = filtered.Where(item => item.Extension_ForeignBook.ID != null);`
    * This is the Filter method that implements the LongBooks3 filter.
5. Put the breakpoint (F9) at the line "return filtered;".
6. In browser, execute web request that will start up the application process and call the filter:
   * `http://localhost/BookstoreRhetosServer/rest/Bookstore/Book/?filters=[{"Filter":"Bookstore.LongBooks3","Value":{"MinimumPages":300}}]`
7. Attach Visual Studio to the web application process: Debug => Attach to process... => Select "w3wp.exe" => Attach.
   * It there are multiple processes named "w3wp.exe", use the one that has User Name same as your
     web application's Application Pool account (usually your domain account).
8. After attaching, the break point should be displayed with a full red circle.
   * It the circle is empty, it means that the breakpoint is not working.
     Check the warning in the tooltip.
     Verify that you have run DeployPackages with the `/Debug` switch (step 1).
9. In browser, execute the web request again.
10. Visual Studio should automatically pause the process on the breakpoint.
    * Move the mouse pointer over the `parameter` variable. You should see the command parameters:
      ForeignBooksOnly=null, MinimumPages=300.
    * Add a Watch entry: `filtered.ToString()`. It should display the SQL query generated by Entity Framework.
      * If you get a warning "The function evaluation requires all threads to run.",
        click the thread icon next to the warning.

## Tips and Tricks

1. You can use LINQPad, instead of the browser, to execute the feature that you need to debug.
   Just attach Visual Studio to LINQPad process instead of w3wp.exe.
   * This is especially helpful if you need multiple steps to prepare the test data,
     or if you want to try different code snippets to test the issue.
     See [Using the Domain Object Model](Using-the-Domain-Object-Model)
     for using LINQPad with Rhetos.
   * For example, to debug a data validation in `InvalidData`, you can directly call
     `repository...Save` method from the LINQPad script.
2. From Visual Studio that is installed on your computer, you can debug the application that has been deployed
   on a different computer. See <https://docs.microsoft.com/en-us/visualstudio/debugger/remote-debugging>.
3. If you want to debug an exception, but you are not sure where to put a breakpoint,
   you can configure Visual Studio to stop automatically on any exception:
   Debug => Windows => Exception Settings => Check the checkbox at "Common Language Runtime Exception".
   By default this checkbox is in the "indeterminate" state (shaded).
4. Use SQL Profiler to see what queries are executed on the database.
   This is helpful if you want to see the *parameter values* for the queries.
5. Rhetos has a detailed [system logging](Logging#system-log) of all actions it performs.
   It is set up to log *errors only* by default, to avoid any performance penalty.
   You can enable more detailed logging to see what is going on inside the application.
   The following examples are often used in practice. To enable each rule,
   uncomment the existing entry in the `Web.config` file:
   * Client requests with short description:
     Uncomment `"ProcessingEngine Request" ... writeTo="TraceLog"`,
     the log entries will be written to Logs\RhetosServerTrace.log.
   * Full data on requests and responses:
     Uncomment `"ProcessingEngine Commands"` and `"ProcessingEngine CommandsResult"`,
     the log entries will be written to Logs\RhetosServerCommandsTrace.xml.
   * Full detailed logging:
     Uncomment `name="*" minLevel="Trace"`,
     the log entries will be written to Logs\RhetosServerTrace.log.
